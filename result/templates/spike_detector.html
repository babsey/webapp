<html>
    <head>
        <title>Scatterplot</title>
        <link rel="stylesheet" href="/media/css/default.css"></link>
        <link rel="stylesheet" href="/media/css/result.css"></link>

        <script type="text/javascript" src="/media/js/jquery-1.6.2.min.js"></script>
        <script type="text/javascript" src="/media/js/protovis.min.js"></script>
        <script type="text/javascript" src="/media/js/jquery.spinedit.js"></script>

    </head>

    <body>
        <div id="center">
            <div id="fig">
                <script type="text/javascript+protovis">
   
                    /* Data of Spikes. */ 
                    var senders = {{ senders|safe }},
                    times = {{ times|safe }}
                    simTime = {{ simTime|safe }},
                    neurons = {{ neurons|safe }},
                    fig = {{ fig|safe }};

                    /* Size of panels. */
                    var w = fig.w,
                    h1 = neurons.length * fig.h1,
                    h2 = fig.h2,
                    h = h1 + 30 + h2;

                    $( "#fig" ).css("width", fig.width).css("height", h);

                    /* Scales of Spikes panel */
                    var xScale = pv.Scale.linear(0, simTime).range(0, w),
                    yScale = pv.Scale.linear(1, neurons.length).range(0, h1);

                    /* Scales of PSTH panel */
                    var bin_width = simTime/10,
                    bin_xTicks = pv.range(0, simTime+1, bin_width);

                    var bins = pv.histogram(times).bins(bin_xTicks),
                    bin_yScale = pv.Scale.linear(0, pv.max(bins, function(d) d.y)).range(0, h2);

                    /* The root panel. */
                    var vis = new pv.Panel()
                        .width(w)
                        .height(h)

                        .top(5)
                        .right(5)
                        .bottom(5)
                        .left(15);


                    /* The spike panel. */
                    var spikes = vis.add(pv.Panel)
                        .top(0)
                        .height(h1);    

                    /* Y-axis and ticks. */
                    spikes.add(pv.Rule)
                        .data(neurons)
                        .top(yScale)
                        .strokeStyle("#ddd")
                      .anchor("left").add(pv.Label)
                        .text(yScale.tickFormat);

                    /* X-axis and ticks. */
                    var grid = spikes.add(pv.Rule)
                        .data(bin_xTicks)
                        .left(xScale)
                        .strokeStyle("#ddd");

                    /* The dot plot! */
                    spikes.add(pv.Dot)
                        .data(times)
                        .left(function(d) xScale(d))
                        .top(function() yScale(senders[this.index]))
                        .strokeStyle("#000")
                        .fillStyle("#000")
                        .size(1);

                    /* X-axis label */
                    spikes.add(pv.Label)
                        .bottom(-1)
                        .textBaseline("top")
                        .left(w/2)
                        .textAlign("center")
                        .text("Time (ms)")
                      .add(pv.Label)
                        .bottom(-1)
                        .textBaseline("top")
                        .left(0)
                        .textAlign("left")
                        .textStyle("grey")
                        .text(senders.length +" spikes");


                    /* The PSTH panel */
                    var psth = vis.add(pv.Panel)
                        .bottom(10)
                        .height(h2);

                    psth.add(pv.Label)
                        .bottom(-1)
                        .textBaseline("top")
                        .left(w/2)
                        .textAlign("center")
                        .textStyle("grey")
                        .text("PSTH");

                    /* The bar plot! */
                    var psth_bars = psth.add(pv.Bar)
                        .data(bins)
                        .bottom(0)
                        .width(xScale(bin_width))
                        .height(function(d) bin_yScale(d.y))
                        .left(function(d) xScale(d.x))
                        .fillStyle("#000")
                        .strokeStyle("rgba(255, 255, 255, .2)");

//                     psth_bars.anchor("top").add(pv.Label)
//                        .textBaseline("bottom")
//                        .text(function(d) d.y);

                    /* the line plot! */
                    var psth_line = psth.add(pv.Line)
                        .data(bins)
                        .left(function(d) xScale(d.x) + xScale(d.dx)/2)
                        .bottom(function(d) bin_yScale(d.y))
                        .lineWidth(3);

                    /* Number of spikes label */
                    psth_line.anchor("top").add(pv.Label)
                        .textBaseline("top")
                        .text(function(d) d.y)
                        .textStyle(function(d) (d.y > 0) ? "lightgrey": "black")
                        .visible(function(d) d.dx >= simTime/20);

                    vis.render();

                    $( "input.spinedit" ).bind("change mouseover mouseup mouseout keyup mousewheel DOMMouseScroll", function () {

                        /* Update PSTH */
                        var bin_width = $("input.spinedit").val();
                        var bin_xTicks = pv.range(0, simTime+1, bin_width);
                        if (simTime%bin_width != 0) {bin_xTicks[bin_xTicks.length] = simTime};

                        var bins = pv.histogram(times).bins(bin_xTicks),
                        bin_yScale = pv.Scale.linear(0, pv.max(bins, function(d) d.y)).range(0, h2);

                        grid.data(bin_xTicks);

                        psth_bars.data(bins)
                            .width(xScale(bin_width))
                            .left(function(d) xScale(d.x))
                            .height(function(d) bin_yScale(d.y));

                        psth_line.data(bins)
                            .data(bins)
                            .left(function(d) xScale(d.x) + xScale(d.dx)/2)
                            .bottom(function(d) bin_yScale(d.y))
                
                        vis.render();
                        });

                    $(function() {
                        $( "input.spinedit" ).SpinEdit({'step':20, 'min': 20, max: simTime}).val(bin_width);
                        });

                </script>

                <p>
                    <label for "bin_width"> Bin width: </label>
                    <input type="text" class="spinedit" id="bin_width"/> ms
                </p>
            </div>
        </div>
    </body>
</html>
