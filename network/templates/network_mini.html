<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">  

{% load lib_filters %}
{% load network_filters %}
{% load network_tags %}
{% load humanize %}

<head>

    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/nuspic/jquery-ui.custom.css?ver=1.8.14" />
    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/jquery-ui.custom.css" />
    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/default.css" />

    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/layout-default.css" />
    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/tipTip.css" />
    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/network.css" />
    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}css/result.css" />

    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.min.js?ver=1.7.1"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-ui.custom.min.js?ver=1.8.14"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.layout.min.js?ver=1.2.0."></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.layout.state.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.cookie.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.tipTip.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/json2.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/network.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/quickpager.jquery.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/raphael.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}js/raphael.networkLayout.js"></script>

    {% if network_obj.has_spike_detector %}
        <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery.spinedit.js"></script>
        <script type="text/javascript" src="{{ MEDIA_URL }}js/d3.v2.min.js"></script>
    {% endif %}

    <style type="text/css">

        .ui-layout-content {
            display: none
        }

        .field-wrapper {
            width:100%
        }

        .field-box {
            height:23px;
            width: 92%;
        }

        .portlet-content {
            margin-left: 0;
            margin-right: 0;
            border-left: 0;
            border-right: 0;
        }

        #spikeDetectorThumbnail {
            margin: 1px; 
            padding: 5px; 
            border: 1px solid #ccc; 
        }
    </style>

    <script type="text/javascript">
        var None = '';
        var network_id = {{ network_obj.id }},
        device_list = {{ network_obj.device_list|safe }},
        neuron_ids = {{ network_obj.neuron_ids|safe }},
        edgelist = {{ network_obj.edgelist|safe }},
        connect_to_input = {{ network_obj.connect_to_input|safe }},
        connect_to_output = {{ network_obj.connect_to_output|safe }},
        layoutSize = {{ network_obj.layout_size|safe }},
        last_device_id = {{ network_obj.last_device_id|safe }},
        params_order = {{ params_order|safe }};

        {% if network_obj.has_spike_detector %}
            var spike_detector_data = {{ spike_detector|safe }};
        {% endif %}

        var selected_device_id,
        task_id;

        layoutState.options.expires = 30;
        $(window).unload(function(){ layoutState.save('myLayout') }); 

        var myDefaultSettings = {
            north__initClosed:            true,
            north__resizable:             false,
//             north__closable:              false,
            north__slideTrigger_open:     "mouseover", 
            north__spacing_closed:        10,
            south__initClosed:            true,
            south__slidable:              false,
            south__onopen_end:            'loadResults',
            south__onclose_start:         'unloadResults',
            west__size:                   370,
            west__minSize:                210,
            west__spacing_closed:         20,
            west__togglerContent_open:    "&#8249;", // "‹"
            west__togglerContent_closed:  "&#8250;", // "›"
        };

        function unloadResults() {
            $( "#VoltmeterThumbnail" ).attr("src","")
            $( "#SpikeDetectorThumbnail" ).attr("src","")
        }

        function loadResults() {
            {% if network_obj.has_voltmeter %}
                $( "#VoltmeterThumbnail" ).attr("src","{% url voltmeter_thumbnail network_obj.pk %}")
                setTimeout('$( "#VoltmeterThumbnail" ).contents().find("span").each(function() { $(this).click(function() {voltmeter_enlarge(this.id)}); })', 2000.)
            {% endif %}


            {% if network_obj.has_spike_detector %}
                $( "#SpikeDetectorThumbnail" ).attr("src","{% url spike_detector network_obj.pk %}?view=small" )
                setTimeout('$( "#SpikeDetectorThumbnail" ).contents().find("span").click(function() {spike_detector_enlarge()})', 2000.)
            {% endif %}
        }

        $(document).ready(function() {

            // CONTENT HEADER
            $( "#banner" ).css("background", "url(/media/images/special/nuspic_banner_small.png) no-repeat")
                    .css('height','85px')
                    .css('width', '880px');

            $( ".ui-layout-content" ).show().css('height', window.innerHeight-45)

            $( ".portlet" ).loadTheme({
                "tipTip": true,
                "shadow": false,
                "toggable": false,
            });

            // ADMIN
            $( "span#device_id" ).html(selected_device_id);
            $( "span#last_device_id" ).html(last_device_id);

            // tipTip
            $( ".tipTip-top" ).tipTip({
                    delay: 1000,
                    defaultPosition: 'top',
            });

            $( ".tipTip-right" ).tipTip({
                    defaultPosition: 'right',
            });

            $( ".tipTip-left" ).tipTip({
                    defaultPosition: 'left',
            });

            $( ".ui-icon" ).hover(function(){$(this).parent().addClass('ui-state-hover')}, 
                function(){$(this).parent().removeClass('ui-state-hover')})

            $( ".network-list" ).change(function() {
                document.location.href = $(this).val();
            });

            $( "#network-label" ).submit(function(e) {
                e.preventDefault();
                $.post('{% url save_label network_obj.id %}',
                    $(this).serialize(),
                    function(data) {
                        var tmp = $( ".network_selector:selected" ).html().split('-')
                        tmp[1] = ' '+ data.label +' '  
                        $( ".network_selector:selected" ).html(tmp.join('-'))
                        
                    }, 'json')
                })

            myLayout = $(".ui-layout-content").layout(
                    $.extend( myDefaultSettings, layoutState.load('myLayout') )
                );

            $( "button.help_text" ).addClass('ui-corner-right').click(function(e) {
                e.preventDefault();
            });

            $( "#devices-toggle" ).click(function() {
                $(this).toggleClass('ui-state-active');
                $( "#device-list" ).slideToggle();
            });

            $( "#connectivity-toggle" ).click(function() {
                $(this).toggleClass('ui-state-active');
                $( "#connectivity_matrix" ).slideToggle();
            });

            $( "#layout-toggle" ).click(function() {
                $(this).toggleClass('ui-state-active');
                $( "#network_layout" ).slideToggle();
            });

            $( "#simulation-toggle" ).click(function() {
                $(this).toggleClass('ui-state-active');
                $( "#network-form" ).slideToggle();
            });

            $( "#results-toggle" ).click(function() {
                $(this).toggleClass('ui-state-active');
                myLayout.toggle('south')
            });

            if ($( "#south" ).hasClass('open')) {
                loadResults()
            }

        });

    </script>
</head>

<body>

    <div>

        <div style="display:inline-block; width:50%" class="field-wrapper">
            <select class="network-list">
                <option value="">--- select a network ---</option>
                {% for network in network_list %}
                    <option class="network_selector" value="{% url network_mini SPIC_obj.group SPIC_obj.local_id network.local_id %}" {% ifequal network.id network_obj.id %} selected {% endifequal %}>
                        {{ network.local_id }} - {{ network.label|default_if_none:" " }} -
                        {% if network.date_simulated %}
                            {{ network.date_simulated|timesince }} ago
                        {% else %}
                            not simulated
                        {% endif %}
                    </option>
                {% endfor %}

            </select>
        </div>

        <div style="display:inline-block; width:40%">
            <form id="network-label">

                {% csrf_token %}

                {% for field in label_form %}
                    {% if field.is_hidden %}
                        {{ field }}
                    {% else %}
                        <div class="field-wrapper" title="{{ field.help_text }}">
                            {{ field.errors }}
                            <div class="field-box" style="width:75%">
                                {{ field }}
                            </div>
                            <button class="ui-corner-right" type="submit" >Save</button>
                        </div>
                    {% endif %}
                {% endfor %}

            </form>

        </div>

    </div>

    <div class="ui-layout-content">

        <div class="ui-layout-north field-wrapper" id="north" style="padding: -1px">

            <button class="ui-state-hover" style="border-top:none; border-bottom:none;" id="devices-toggle">Devices</button>
            <button {% if network_obj.neuron_ids|length <= 10 and network_obj.weight_list %} class="ui-state-hover" {% else %} disabled {% endif %} style="border-top:none; border-bottom:none;" id="connectivity-toggle">Connectivity Matrix</button>
            <button {% if network_obj.connections %} class="ui-state-hover" {% else %} disabled {% endif %} style="border-top:none; border-bottom:none;" id="layout-toggle">Network Layout</button>
            <button class="ui-state-hover" style="border-top:none; border-bottom:none;" id="simulation-toggle">Simulation</button>
            <button {% if network_obj.is_recorded %} class="ui-state-hover ui-state-active" {% else %} disabled {% endif %} style="border-top:none; border-bottom:none;" id="results-toggle">Results</button>

        </div>

        <div class="ui-layout-west">
        
            <div id="devices">
        
        <!--         DEVICE LIST -->
                {% include "device_list.html" %}
        
        <!--         DEVICE FORMS -->
                {% include "device_formsets.html" %}
        
            </div>
        </div>
        
        <div class="ui-layout-center">

            <div id="network">

                {% if network_obj.connections %}

        <!--             CONNECTIVITY MATRIX   -->
                    {% include "connectivity_matrix.html" %}
        
        <!--             NETWORK LAYOUT   -->
                    {% include "raphael.network_layout.html" %}

                {% endif %}
        
        <!--             SIMULATION   -->
                {% include "simulation.html" %}
        
              </div>
        
        </div>

        {% if network_obj.is_recorded %}
            <div class="ui-layout-south" id="south">
            
            <!--            RESULT   -->
                {% include "result_south.html" %}

            </div>
        {% endif %}


    <!-- POPUP DIALOG -->
    <div class="ui-dialog" id="dialog-msg" title="Network messenger">

        <div style="width:56px; height: 54px; margin:auto; padding:12px; display:none; float:left; vertical-align:bottom" id="loading_icon">
            <img src="/media/images/icons/bcf_logo-loader.gif" style="height:100%;width:100%;">
        </div>

        <p id="dialog-msg" style="margin-top: 60px"></p>

    </div>

</body>

</html>